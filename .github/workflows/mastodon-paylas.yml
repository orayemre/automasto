name: Mastodon Otomatik PaylaÅŸÄ±m

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  paylas:
    runs-on: ubuntu-latest
    steps:
      - name: Gist'ten DosyayÄ± Ä°ndir
        run: |
          echo "Gist'ten hikayeler dosyasÄ± indiriliyor..."
          curl -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/gists/fa7b2f4758251a7901a64d3715b171d7 \
               -o gist.json
          
          # jq aracÄ± ile JSON dosyasÄ±ndan hikayeler.txt iÃ§eriÄŸini ayÄ±kla
          sudo apt-get update && sudo apt-get install -y jq
          cat gist.json | jq -r '.files["hikayeler.txt"].content' > hikayeler.txt
          
          # DosyanÄ±n boÅŸ olup olmadÄ±ÄŸÄ±nÄ± kontrol et
          if [ ! -s "hikayeler.txt" ]; then
            echo "Hikayeler dosyasÄ± boÅŸ!"
            exit 1
          fi
          
          echo "âœ… $(wc -l < hikayeler.txt) hikaye indirildi"

      - name: Node.js Kur
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Paketleri Kur
        run: npm install axios

      - name: Mastodon'da PaylaÅŸÄ±m Yap
        run: |
          cat << 'EOF' > mastodon-paylas.js
          const fs = require('fs');
          const axios = require('axios');

          // Hikayeler dosyasÄ±nÄ± oku ve boÅŸ satÄ±rlarÄ± filtrele
          const hikayeler = fs.readFileSync('hikayeler.txt', 'utf8')
                               .split('\n')
                               .filter(line => line.trim() !== '');

          const MASTODON_HOST = 'https://sosyal.teknofest.app';
          const MASTODON_TOKEN = process.env.MASTODON_TOKEN;
          const headers = {
            'Authorization': `Bearer ${MASTODON_TOKEN}`,
            'Content-Type': 'application/json',
          };

          // Rastgele 3 hikaye seÃ§
          const secilenHikayeler = hikayeler.sort(() => 0.5 - Math.random()).slice(0, 3);

          async function paylas() {
            console.log(`\nğŸ¯ ${secilenHikayeler.length} hikaye paylaÅŸÄ±lacak`);
            for (const hikaye of secilenHikayeler) {
              if (hikaye.length > 0) {
                try {
                  console.log(`\nğŸ“ PaylaÅŸÄ±m yapÄ±lÄ±yor: "${hikaye.substring(0, 50)}..."`);
                  
                  const response = await axios.post(`${MASTODON_HOST}/api/v1/statuses`, {
                    status: hikaye,
                    visibility: 'public'
                  }, { headers: headers });
                  
                  // URL'yi doÄŸrudan yanÄ±ttan al
                  const postUrl = response.data.url;
                  
                  if (postUrl) {
                    console.log(`âœ… BaÅŸarÄ±yla paylaÅŸÄ±ldÄ±: ${postUrl}`);
                  } else {
                    console.error('âŒ PaylaÅŸÄ±m URL\'si alÄ±namadÄ±, ancak paylaÅŸÄ±m baÅŸarÄ±lÄ± gibi gÃ¶rÃ¼nÃ¼yor.');
                    console.log(`YanÄ±t verisi: ${JSON.stringify(response.data)}`);
                  }
                  
                  // PaylaÅŸÄ±mlar arasÄ± 5 saniye bekle
                  await new Promise(resolve => setTimeout(resolve, 5000));
                } catch (err) {
                  console.error('âŒ PaylaÅŸÄ±m baÅŸarÄ±sÄ±z:', err.response?.data?.error || err.message);
                }
              }
            }
          }

          paylas();
          EOF
          
          echo "ğŸš€ Mastodon paylaÅŸÄ±m botu baÅŸlatÄ±lÄ±yor..."
          node mastodon-paylas.js
        env:
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
