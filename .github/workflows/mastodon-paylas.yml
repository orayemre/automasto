name: Mastodon Otomatik Paylaşım

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  paylas:
    runs-on: ubuntu-latest
    steps:
      - name: Node.js Kur
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Paketleri Kur
        run: npm install mastodon-api

      - name: Gist'ten Dosyayı İndir
        run: |
          echo "Gist'ten hikayeler dosyası indiriliyor..."
          curl -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/gists/fa7b2f4758251a7901a64d3715b171d7 \
               -o gist.json
          
          sudo apt-get update && sudo apt-get install -y jq
          cat gist.json | jq -r '.files["hikayeler.txt"].content' > hikayeler.txt
          
          if [ ! -s "hikayeler.txt" ]; then
            echo "Hikayeler dosyası boş!"
            exit 1
          fi
          
          echo "✅ $(wc -l < hikayeler.txt) hikaye indirildi"

      - name: Mastodon'da Paylaşım Yap
        run: |
          cat << 'EOF' > mastodon-paylas.js
          const fs = require('fs');
          const Mastodon = require('mastodon-api');

          const hikayeler = fs.readFileSync('hikayeler.txt', 'utf8')
                               .split('\n')
                               .filter(line => line.trim() !== '');

          const mastodon = new Mastodon({
            client_key: process.env.CLIENT_KEY,
            client_secret: process.env.CLIENT_SECRET,
            access_token: process.env.MASTODON_TOKEN,
            api_url: 'https://sosyal.teknofest.app/api/v1/'
          });

          const secilenHikayeler = hikayeler.sort(() => 0.5 - Math.random()).slice(0, 3);

          async function paylas() {
            console.log(`\n🎯 ${secilenHikayeler.length} hikaye paylaşılacak`);
            for (const hikaye of secilenHikayeler) {
              if (hikaye.length > 0) {
                try {
                  console.log(`\n📝 Paylaşım yapılıyor: "${hikaye.substring(0, 50)}..."`);
                  const resp = await mastodon.post('statuses', { status: hikaye });
                  console.log('API Yanıtı:', JSON.stringify(resp.data, null, 2));
                  
                  let postUrl = resp?.data?.url || resp?.data?.uri;
                  if (!postUrl && resp?.data?.id) {
                    postUrl = `https://sosyal.teknofest.app/@mukavemet/${resp.data.id}`;
                  }
                  
                  if (postUrl) {
                    console.log(`✅ Başarıyla paylaşıldı: ${postUrl}`);
                  } else {
                    console.error('❌ Paylaşım URL\'si bulunamadı.');
                    console.log(`Tam yanıt: ${JSON.stringify(resp.data, null, 2)}`);
                  }
                  
                  await new Promise(resolve => setTimeout(resolve, 5000));
                } catch (err) {
                  console.error('❌ Paylaşım başarısız:');
                  if (err.response) {
                    console.error(`Durum kodu: ${err.response.status}`);
                    console.error(`Hata verisi: ${JSON.stringify(err.response.data, null, 2)}`);
                  } else {
                    console.error(`Hata mesajı: ${err.message}`);
                  }
                }
              }
            }
          }

          paylas();
          EOF
          
          echo "🚀 Mastodon paylaşım botu başlatılıyor..."
          node mastodon-paylas.js
        env:
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
          CLIENT_KEY: ${{ secrets.CLIENT_KEY }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
