name: Mastodon Otomatik Paylaşım
on:
  schedule:
    - cron: '0 8 * * *'  # Her gün saat 8:00'de çalışır
  workflow_dispatch:  # Manuel çalıştırma için

jobs:
  paylas:
    runs-on: ubuntu-latest
    steps:
      - name: Node.js Kur
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Gist'ten Dosyayı İndir
        run: |
          echo "Gist'ten hikayeler dosyası indiriliyor..."
          curl -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/gists/fa7b2f4758251a7901a64d3715b171d7 \
               -o gist.json
          
          echo "Gist yanıtı kontrol ediliyor..."
          if [ ! -f "gist.json" ]; then
            echo "Gist dosyası indirilemedi!"
            exit 1
          fi
          
          # JSON dosyasını kontrol et
          cat gist.json
          echo ""
          echo "========================"
          
          # jq kurulu değilse kuralım
          sudo apt-get update && sudo apt-get install -y jq
          
          # Gist içeriğini çıkar ve hikayeler.txt dosyasını oluştur
          cat gist.json | jq -r '.files["hikayeler.txt"].content' > hikayeler.txt
          
          # Dosyanın indirilip indirilmediğini kontrol et
          if [ ! -f "hikayeler.txt" ] || [ ! -s "hikayeler.txt" ]; then
            echo "Hikayeler dosyası oluşturulamadı veya boş!"
            echo "Gist içeriği:"
            cat gist.json | jq '.files'
            exit 1
          fi
          
          echo "Hikayeler dosyası başarıyla indirildi:"
          wc -l hikayeler.txt
          echo "İlk 3 satır:"
          head -3 hikayeler.txt
          
      - name: Paketleri Kur
        run: npm install mastodon-api
        
      - name: Mastodon Bağlantısını Test Et
        run: |
          cat << 'EOF' > test.js
          const Mastodon = require('mastodon-api');
          const mastodon = new Mastodon({
            access_token: process.env.MASTODON_TOKEN,
            api_url: 'https://sosyal.teknofest.app/api/v1/'
          });
          
          async function testConnection() {
            try {
              console.log('Mastodon hesap bilgileri kontrol ediliyor...');
              const account = await mastodon.get('accounts/verify_credentials');
              
              console.log('✓ Mastodon API yanıtı alındı!');
              console.log('API Yanıt Yapısı:');
              console.log('account.data tipi:', typeof account.data);
              console.log('account.resp status:', account.resp?.statusCode);
              console.log('Ham yanıt (ilk 500 karakter):');
              console.log(JSON.stringify(account, null, 2).substring(0, 500) + '...');
              
              // Farklı veri yapısı kontrolü
              let userData = account.data || account;
              
              console.log('Hesap bilgileri:');
              console.log('- Kullanıcı adı:', userData.username || userData.acct || 'Bulunamadı');
              console.log('- Display name:', userData.display_name || userData.displayName || 'Bulunamadı');
              console.log('- ID:', userData.id || 'Bulunamadı');
              console.log('- Profil URL:', userData.url || userData.uri || 'Bulunamadı');
              
              // Son paylaşımları kontrol et
              console.log('\nSon paylaşımlar kontrol ediliyor...');
              const timeline = await mastodon.get('timelines/home', { limit: 3 });
              
              console.log('Timeline API Yanıtı:');
              console.log('timeline.data tipi:', typeof timeline.data);
              console.log('timeline.data uzunluk:', Array.isArray(timeline.data) ? timeline.data.length : 'Array değil');
              
              if (Array.isArray(timeline.data) && timeline.data.length > 0) {
                console.log('İlk paylaşım yapısı:');
                console.log(JSON.stringify(timeline.data[0], null, 2).substring(0, 300) + '...');
              }
              
            } catch (err) {
              console.error('✗ Mastodon bağlantı hatası:');
              console.error('Hata mesajı:', err.message);
              if (err.response) {
                console.error('HTTP Status:', err.response.status);
                console.error('Response Data:', JSON.stringify(err.response.data, null, 2));
              }
              process.exit(1);
            }
          }
          
          testConnection();
          EOF
          
          node test.js
        env:
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
        
      - name: Paylaşımı Yap
        run: |
          cat << 'EOF' > script.js
          const fs = require('fs');
          const path = require('path');
          
          // Dosya varlığını kontrol et
          const hikayelerPath = path.join(__dirname, 'hikayeler.txt');
          if (!fs.existsSync(hikayelerPath)) {
            console.error('hikayeler.txt dosyası bulunamadı!');
            process.exit(1);
          }
          
          const hikayeler = fs.readFileSync(hikayelerPath, 'utf8')
                               .split('\n')
                               .filter(line => line.trim() !== '')
                               .filter(line => line.length > 10); // Çok kısa satırları filtrele
          
          if (hikayeler.length === 0) {
            console.error('Geçerli hikaye bulunamadı!');
            process.exit(1);
          }
          
          console.log(`Toplam ${hikayeler.length} hikaye bulundu`);
          
          const Mastodon = require('mastodon-api');
          const mastodon = new Mastodon({
            access_token: process.env.MASTODON_TOKEN,
            api_url: 'https://sosyal.teknofest.app/api/v1/'
          });
          
          // 5 rastgele hikaye seç
          const secilenHikayeler = hikayeler.sort(() => 0.5 - Math.random()).slice(0, 5);
          
          async function paylas() {
            let basariliPaylasmlar = 0;
            
            for (let i = 0; i < secilenHikayeler.length; i++) {
              const hikaye = secilenHikayeler[i];
              
              if (hikaye.length > 0) {
                try {
                  console.log(`${i + 1}. hikaye paylaşılıyor...`);
                  console.log(`İçerik uzunluğu: ${hikaye.length} karakter`);
                  
                  // Mastodon karakter sınırını kontrol et (500 karakter)
                  const paylasilacakHikaye = hikaye.length > 480 ? 
                    hikaye.substring(0, 477) + '...' : hikaye;
                  
                  const resp = await mastodon.post('statuses', { 
                    status: paylasilacakHikaye,
                    visibility: 'public'
                  });
                  
                  // Detaylı yanıt logla
                  console.log('API Yanıt Detayları:');
                  console.log('Response tipi:', typeof resp);
                  console.log('Response.data tipi:', typeof resp.data);
                  console.log('Status Code:', resp.resp?.statusCode || 'Bilinmiyor');
                  console.log('Ham Response (ilk 300 karakter):');
                  console.log(JSON.stringify(resp, null, 2).substring(0, 300) + '...');
                  
                  // Farklı veri yapıları için ID'yi bul
                  let postData = resp.data || resp;
                  let postId = postData.id || postData.uri?.split('/').pop();
                  
                  if (postId) {
                    const postUrl = `https://sosyal.teknofest.app/@terikisi/${postId}`;
                    console.log(`✓ ${i + 1}. hikaye başarıyla paylaşıldı: ${postUrl}`);
                  } else {
                    console.log(`✓ ${i + 1}. hikaye paylaşıldı ama ID bulunamadı`);
                    console.log('Mevcut post data:', JSON.stringify(postData));
                  }
                  basariliPaylasmlar++;
                  
                  // Paylaşımlar arasında 3 saniye bekle
                  if (i < secilenHikayeler.length - 1) {
                    console.log('3 saniye bekleniyor...');
                    await new Promise(resolve => setTimeout(resolve, 3000));
                  }
                  
                } catch (err) {
                  console.error(`✗ ${i + 1}. hikaye paylaşılırken hata oluştu:`);
                  console.error('Hata detayı:', err.message);
                  if (err.response && err.response.data) {
                    console.error('API yanıtı:', JSON.stringify(err.response.data, null, 2));
                  }
                }
              }
            }
            
            console.log(`\n=== ÖZET ===`);
            console.log(`Toplam paylaşım denemesi: ${secilenHikayeler.length}`);
            console.log(`Başarılı paylaşım: ${basariliPaylasmlar}`);
            console.log(`Başarısız paylaşım: ${secilenHikayeler.length - basariliPaylasmlar}`);
          }
          
          paylas().catch(err => {
            console.error('Ana fonksiyonda hata:', err);
            process.exit(1);
          });
          EOF
          
          node script.js
        env:
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
