name: Mastodon Otomatik Paylaşım
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  paylas:
    runs-on: ubuntu-latest
    steps:
      - name: Node.js Kur
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Gist'ten Dosyayı İndir
        run: |
          echo "Gist'ten hikayeler dosyası indiriliyor..."
          curl -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/gists/fa7b2f4758251a7901a64d3715b171d7 \
               -o gist.json
          
          echo "Gist yanıtı kontrol ediliyor..."
          if [ ! -f "gist.json" ]; then
            echo "Gist dosyası indirilemedi!"
            exit 1
          fi
          
          sudo apt-get update && sudo apt-get install -y jq
          cat gist.json | jq -r '.files["hikayeler.txt"].content' > hikayeler.txt
          
          if [ ! -f "hikayeler.txt" ] || [ ! -s "hikayeler.txt" ]; then
            echo "Hikayeler dosyası oluşturulamadı veya boş!"
            exit 1
          fi
          
          echo "Hikayeler dosyası başarıyla indirildi:"
          wc -l hikayeler.txt
          
      - name: API Test ve Paylaşım
        run: |
          echo "=== Mastodon API Testi ==="
          
          # 1. Instance bilgisi
          echo "1. Instance bilgisi kontrol ediliyor..."
          curl -H "User-Agent: MastodonBot/1.0" "https://sosyal.teknofest.app/api/v1/instance" 2>/dev/null | head -5
          
          echo ""
          echo "2. Hesap bilgileri kontrol ediliyor..."
          # Hesap doğrulama
          ACCOUNT_RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.MASTODON_TOKEN }}" \
            -H "User-Agent: MastodonBot/1.0.0" \
            -H "Accept: application/json" \
            "https://sosyal.teknofest.app/api/v1/accounts/verify_credentials")
          
          echo "API Yanıt (ilk 200 karakter):"
          echo "$ACCOUNT_RESPONSE" | head -c 200
          echo ""
          
          # HTML response kontrolü (Cloudflare kontrolü)
          if echo "$ACCOUNT_RESPONSE" | grep -q "<!DOCTYPE html>"; then
            echo "❌ Cloudflare engeli tespit edildi!"
            echo "GitHub Actions IP'si engellenmiş olabilir."
          else
            echo "✅ API yanıtı HTML değil, JSON olabilir"
          fi
          
          echo ""
          echo "3. Test paylaşımı yapılıyor..."
          # Test paylaşımı
          POST_RESPONSE=$(curl -s \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.MASTODON_TOKEN }}" \
            -H "User-Agent: MastodonBot/1.0.0" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -d '{"status":"🤖 GitHub Actions test paylaşımı - ' $(date) '","visibility":"public"}' \
            "https://sosyal.teknofest.app/api/v1/statuses")
          
          echo "Paylaşım API Yanıt (ilk 300 karakter):"
          echo "$POST_RESPONSE" | head -c 300
          echo ""
          
          # Başarı kontrolü
          if echo "$POST_RESPONSE" | grep -q '"id"'; then
            echo "✅ Test paylaşımı başarılı!"
            echo "Paylaşım ID'si bulundu."
          elif echo "$POST_RESPONSE" | grep -q "<!DOCTYPE html>"; then
            echo "❌ Paylaşımda da Cloudflare engeli!"
          else
            echo "⚠️ Belirsiz durum - API yanıtını kontrol edin"
          fi
          
          echo ""
          echo "=== Hikaye Paylaşımları ==="
          
          # Node.js ile hikaye paylaşımları
          npm install mastodon-api
          
          cat << 'EOF' > script.js
          const fs = require('fs');
          
          // Hikayeler dosyasını oku
          const hikayeler = fs.readFileSync('hikayeler.txt', 'utf8')
                               .split('\n')
                               .filter(line => line.trim() !== '')
                               .filter(line => line.length > 10);
          
          console.log(`Toplam ${hikayeler.length} hikaye bulundu`);
          
          if (hikayeler.length === 0) {
            console.error('Geçerli hikaye bulunamadı!');
            process.exit(1);
          }
          
          // curl ile paylaşım fonksiyonu  
          async function curlPost(hikaye, index) {
            const { spawn } = require('child_process');
            
            return new Promise((resolve, reject) => {
              const hikayeEscaped = hikaye.replace(/"/g, '\\"').replace(/'/g, "\\'");
              const curlArgs = [
                '-s', '-X', 'POST',
                '-H', 'Authorization: Bearer ' + process.env.MASTODON_TOKEN,
                '-H', 'User-Agent: MastodonBot/1.0.0',
                '-H', 'Accept: application/json',
                '-H', 'Content-Type: application/json',
                '-d', JSON.stringify({
                  status: hikaye.length > 480 ? hikaye.substring(0, 477) + '...' : hikaye,
                  visibility: 'public'
                }),
                'https://sosyal.teknofest.app/api/v1/statuses'
              ];
              
              const curl = spawn('curl', curlArgs);
              let output = '';
              
              curl.stdout.on('data', (data) => {
                output += data.toString();
              });
              
              curl.on('close', (code) => {
                console.log(`${index + 1}. hikaye yanıtı (${hikaye.length} karakter):`);
                console.log(output.substring(0, 200) + (output.length > 200 ? '...' : ''));
                
                if (output.includes('"id"')) {
                  console.log(`✅ ${index + 1}. hikaye başarılı`);
                  resolve(true);
                } else if (output.includes('<!DOCTYPE html>')) {
                  console.log(`❌ ${index + 1}. hikaye - Cloudflare engeli`);
                  resolve(false);
                } else {
                  console.log(`⚠️ ${index + 1}. hikaye - belirsiz durum`);
                  resolve(false);
                }
              });
              
              curl.on('error', reject);
            });
          }
          
          // 3 rastgele hikaye seç ve paylaş
          const secilenHikayeler = hikayeler.sort(() => 0.5 - Math.random()).slice(0, 3);
          
          async function paylas() {
            let basarili = 0;
            
            for (let i = 0; i < secilenHikayeler.length; i++) {
              const result = await curlPost(secilenHikayeler[i], i);
              if (result) basarili++;
              
              // 2 saniye bekle
              if (i < secilenHikayeler.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 2000));
              }
            }
            
            console.log(`\n=== SONUÇ ===`);
            console.log(`Toplam: ${secilenHikayeler.length}, Başarılı: ${basarili}`);
          }
          
          paylas().catch(console.error);
          EOF
          
          node script.js
        env:
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
