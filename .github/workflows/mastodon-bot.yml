name: Mastodon Otomatik PaylaÅŸÄ±m
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  paylas:
    runs-on: ubuntu-latest
    steps:
      - name: Node.js Kur
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Gist'ten DosyayÄ± Ä°ndir
        run: |
          echo "Gist'ten hikayeler dosyasÄ± indiriliyor..."
          curl -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/gists/fa7b2f4758251a7901a64d3715b171d7 \
               -o gist.json
          
          echo "Gist yanÄ±tÄ± kontrol ediliyor..."
          if [ ! -f "gist.json" ]; then
            echo "Gist dosyasÄ± indirilemedi!"
            exit 1
          fi
          
          sudo apt-get update && sudo apt-get install -y jq
          cat gist.json | jq -r '.files["hikayeler.txt"].content' > hikayeler.txt
          
          if [ ! -f "hikayeler.txt" ] || [ ! -s "hikayeler.txt" ]; then
            echo "Hikayeler dosyasÄ± oluÅŸturulamadÄ± veya boÅŸ!"
            exit 1
          fi
          
          echo "Hikayeler dosyasÄ± baÅŸarÄ±yla indirildi:"
          wc -l hikayeler.txt
          
      - name: API Test ve PaylaÅŸÄ±m
        run: |
          echo "=== Mastodon API Testi ==="
          
          # 1. Instance bilgisi
          echo "1. Instance bilgisi kontrol ediliyor..."
          curl -H "User-Agent: MastodonBot/1.0" "https://sosyal.teknofest.app/api/v1/instance" 2>/dev/null | head -5
          
          echo ""
          echo "2. Hesap bilgileri kontrol ediliyor..."
          # Hesap doÄŸrulama
          ACCOUNT_RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.MASTODON_TOKEN }}" \
            -H "User-Agent: MastodonBot/1.0.0" \
            -H "Accept: application/json" \
            "https://sosyal.teknofest.app/api/v1/accounts/verify_credentials")
          
          echo "API YanÄ±t (ilk 200 karakter):"
          echo "$ACCOUNT_RESPONSE" | head -c 200
          echo ""
          
          # HTML response kontrolÃ¼ (Cloudflare kontrolÃ¼)
          if echo "$ACCOUNT_RESPONSE" | grep -q "<!DOCTYPE html>"; then
            echo "âŒ Cloudflare engeli tespit edildi!"
            echo "GitHub Actions IP'si engellenmiÅŸ olabilir."
          else
            echo "âœ… API yanÄ±tÄ± HTML deÄŸil, JSON olabilir"
          fi
          
          echo ""
          echo "3. Test paylaÅŸÄ±mÄ± yapÄ±lÄ±yor..."
          # Test paylaÅŸÄ±mÄ±
          POST_RESPONSE=$(curl -s \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.MASTODON_TOKEN }}" \
            -H "User-Agent: MastodonBot/1.0.0" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -d '{"status":"ğŸ¤– GitHub Actions test paylaÅŸÄ±mÄ± - ' $(date) '","visibility":"public"}' \
            "https://sosyal.teknofest.app/api/v1/statuses")
          
          echo "PaylaÅŸÄ±m API YanÄ±t (ilk 300 karakter):"
          echo "$POST_RESPONSE" | head -c 300
          echo ""
          
          # BaÅŸarÄ± kontrolÃ¼
          if echo "$POST_RESPONSE" | grep -q '"id"'; then
            echo "âœ… Test paylaÅŸÄ±mÄ± baÅŸarÄ±lÄ±!"
            echo "PaylaÅŸÄ±m ID'si bulundu."
          elif echo "$POST_RESPONSE" | grep -q "<!DOCTYPE html>"; then
            echo "âŒ PaylaÅŸÄ±mda da Cloudflare engeli!"
          else
            echo "âš ï¸ Belirsiz durum - API yanÄ±tÄ±nÄ± kontrol edin"
          fi
          
          echo ""
          echo "=== Hikaye PaylaÅŸÄ±mlarÄ± ==="
          
          # Node.js ile hikaye paylaÅŸÄ±mlarÄ±
          npm install mastodon-api
          
          cat << 'EOF' > script.js
          const fs = require('fs');
          
          // Hikayeler dosyasÄ±nÄ± oku
          const hikayeler = fs.readFileSync('hikayeler.txt', 'utf8')
                               .split('\n')
                               .filter(line => line.trim() !== '')
                               .filter(line => line.length > 10);
          
          console.log(`Toplam ${hikayeler.length} hikaye bulundu`);
          
          if (hikayeler.length === 0) {
            console.error('GeÃ§erli hikaye bulunamadÄ±!');
            process.exit(1);
          }
          
          // curl ile paylaÅŸÄ±m fonksiyonu  
          async function curlPost(hikaye, index) {
            const { spawn } = require('child_process');
            
            return new Promise((resolve, reject) => {
              const hikayeEscaped = hikaye.replace(/"/g, '\\"').replace(/'/g, "\\'");
              const curlArgs = [
                '-s', '-X', 'POST',
                '-H', 'Authorization: Bearer ' + process.env.MASTODON_TOKEN,
                '-H', 'User-Agent: MastodonBot/1.0.0',
                '-H', 'Accept: application/json',
                '-H', 'Content-Type: application/json',
                '-d', JSON.stringify({
                  status: hikaye.length > 480 ? hikaye.substring(0, 477) + '...' : hikaye,
                  visibility: 'public'
                }),
                'https://sosyal.teknofest.app/api/v1/statuses'
              ];
              
              const curl = spawn('curl', curlArgs);
              let output = '';
              
              curl.stdout.on('data', (data) => {
                output += data.toString();
              });
              
              curl.on('close', (code) => {
                console.log(`${index + 1}. hikaye yanÄ±tÄ± (${hikaye.length} karakter):`);
                console.log(output.substring(0, 200) + (output.length > 200 ? '...' : ''));
                
                if (output.includes('"id"')) {
                  console.log(`âœ… ${index + 1}. hikaye baÅŸarÄ±lÄ±`);
                  resolve(true);
                } else if (output.includes('<!DOCTYPE html>')) {
                  console.log(`âŒ ${index + 1}. hikaye - Cloudflare engeli`);
                  resolve(false);
                } else {
                  console.log(`âš ï¸ ${index + 1}. hikaye - belirsiz durum`);
                  resolve(false);
                }
              });
              
              curl.on('error', reject);
            });
          }
          
          // 3 rastgele hikaye seÃ§ ve paylaÅŸ
          const secilenHikayeler = hikayeler.sort(() => 0.5 - Math.random()).slice(0, 3);
          
          async function paylas() {
            let basarili = 0;
            
            for (let i = 0; i < secilenHikayeler.length; i++) {
              const result = await curlPost(secilenHikayeler[i], i);
              if (result) basarili++;
              
              // 2 saniye bekle
              if (i < secilenHikayeler.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 2000));
              }
            }
            
            console.log(`\n=== SONUÃ‡ ===`);
            console.log(`Toplam: ${secilenHikayeler.length}, BaÅŸarÄ±lÄ±: ${basarili}`);
          }
          
          paylas().catch(console.error);
          EOF
          
          node script.js
        env:
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
